<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>注音造詞產生器 - 暖心教育宋體版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 自動連結外部資料庫檔案 -->
    <script src="zhuyin_data.js"></script>
    <style>
        /* 載入思源宋體 Noto Serif TC (包含 400, 500, 700, 900) */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --char-size: 3.5rem;
            --unit-height: 105px;
            --zhuyin-font: 1.25rem;
            --primary-warm: #ff8c42;
        }

        /* 強制所有元素使用宋體，解決字體跑掉的問題 */
        * {
            font-family: 'Noto Serif TC', serif !important;
        }

        @media (max-width: 640px) {
            :root {
                --char-size: 1.35rem; 
                --unit-height: 60px;  
                --zhuyin-font: 0.7rem; 
            }
            .tone-side { right: -5px !important; }
        }

        body {
            background-color: #fffcf0; /* 暖奶油色 */
            background-image: radial-gradient(#ff8c4215 1px, transparent 1px);
            background-size: 30px 30px;
            color: #433422;
            -webkit-tap-highlight-color: transparent;
        }

        /* 自定義捲動桿樣式，防止溢出框線且美化 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #ff8c4240;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #ff8c4260;
        }

        /* 網頁預覽樣式 */
        .word-container { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .char-unit { display: flex; flex-direction: row-reverse; align-items: center; justify-content: center; height: var(--unit-height); margin-bottom: 2px; }
        .char-text { 
            font-size: var(--char-size); 
            line-height: 1; 
            font-weight: 700;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: calc(var(--char-size) * 1.1); 
            height: var(--unit-height); 
            color: #2d241e; 
        }
        .zhuyin-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; height: var(--unit-height); width: calc(var(--zhuyin-font) * 2.4); margin-left: 1px; }
        .zhuyin-symbols { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: var(--zhuyin-font); line-height: 1.1; color: #d35400; font-weight: bold; }
        
        .tone-side { position: absolute; right: -10px; top: 50%; transform: translateY(-50%); font-size: calc(var(--zhuyin-font) * 1.05); color: #2563eb; }
        .tone-top { position: absolute; top: 2px; left: 50%; transform: translateX(-50%); font-size: calc(var(--zhuyin-font) * 1.15); color: #2563eb; font-weight: 900; }

        .glass-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 2rem;
            box-shadow: 0 15px 35px -5px rgba(139, 69, 19, 0.08);
        }

        .warm-input {
            background: #ffffff;
            border: 2px solid #f9ebbe;
            transition: all 0.3s ease;
        }
        .warm-input:focus {
            border-color: var(--primary-warm);
            box-shadow: 0 0 0 4px rgba(255, 140, 66, 0.1);
            outline: none;
        }

        .btn-sunset {
            background: linear-gradient(135deg, #ff8c42, #ffb347);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 140, 66, 0.25);
        }

        /* 浮動視窗樣式 (Modal) */
        #modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        #modal-content {
            background: #fffcf0;
            width: 100%;
            max-width: 500px;
            border-radius: 2.5rem;
            padding: 2.5rem;
            border: 2px solid #f9ebbe;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        #capture-area { background: #ffffff; position: absolute; left: -9999px; top: 0; box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; }

        #zhuyin-picker {
            display: none;
            position: absolute;
            z-index: 1000;
            background: white;
            border: 2px solid #f9ebbe;
            border-radius: 1.5rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            padding: 16px;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            max-width: 95vw;
        }
        @media (max-width: 640px) { #zhuyin-picker { grid-template-columns: repeat(6, 1fr); } }
        .picker-key { display: flex; align-items: center; justify-content: center; width: 38px; height: 38px; background: #fffcf0; border-radius: 12px; font-weight: 700; color: #d35400; cursor: pointer; transition: all 0.2s; border: 1px solid #f9ebbe; }
        .picker-key:hover { background: #ffedd5; transform: scale(1.1); border-color: #ff8c42; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ff8c42; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen py-8 px-4" onclick="closeAllPickers()">
    
    <div class="max-w-4xl mx-auto">
        <!-- 頂部標題區 -->
        <div class="text-center mb-12 relative">
            <div class="inline-flex items-center gap-2 px-4 py-1.5 bg-orange-100 text-orange-600 rounded-full text-xs font-bold tracking-widest uppercase mb-4 shadow-sm">
                <i data-lucide="sparkles" class="w-3.5 h-3.5"></i> 教學輔助工具
            </div>
            <h1 class="text-3xl sm:text-5xl font-black text-orange-950 tracking-tight mb-4 drop-shadow-sm">注音造詞產生器</h1>
            <p class="text-orange-800/60 font-medium max-w-lg mx-auto leading-relaxed">為小朋友打造最溫馨、專業的識字與書寫練習空間</p>
            
            <!-- 使用說明按鈕：i 圓圈風格 -->
            <button onclick="toggleManual(event)" class="absolute right-0 top-0 w-10 h-10 sm:w-12 sm:h-12 bg-white rounded-full shadow-sm border border-orange-100 flex items-center justify-center text-orange-500 hover:bg-orange-50 transition-all">
                <i data-lucide="info" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- 練習操作區 -->
        <div class="space-y-8 mb-12">
            <!-- 第一區 -->
            <div id="section-top" class="section-block">
                <div class="glass-card p-4 sm:p-8 border-t-4 border-orange-400">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-orange-500 text-white rounded-xl flex items-center justify-center font-black shadow-lg shadow-orange-200">1</div>
                        <h2 class="text-2xl font-black text-orange-900">第一區：上半部造詞</h2>
                    </div>
                    <div class="flex flex-row gap-4 w-full">
                        <div class="relative w-1/2 group">
                            <input type="text" class="zhuyin-input warm-input w-full px-2 sm:px-6 py-4 rounded-2xl text-lg sm:text-xl text-center font-black cursor-pointer shadow-sm" placeholder="請選擇注音" readonly onclick="openZhuyinPicker(event, this)">
                            <i data-lucide="chevron-down" class="hidden sm:block absolute right-4 top-1/2 -translate-y-1/2 text-orange-300 group-hover:text-orange-500 transition-colors"></i>
                        </div>
                        <button onclick="handleSectionAction('section-top')" class="action-btn w-1/2 btn-sunset py-4 rounded-2xl font-black text-base sm:text-lg transition-all flex items-center justify-center gap-2">
                            <i data-lucide="sparkles" class="w-4 h-4 sm:w-5 sm:h-5"></i> <span class="btn-text">產生造詞</span>
                        </button>
                    </div>
                    <div class="result-area hidden mt-4 pt-4 border-t border-orange-100/50">
                        <div class="word-grid grid grid-cols-4 gap-1.5 sm:gap-4"></div>
                    </div>
                </div>
            </div>

            <!-- 第二區 -->
            <div id="section-bottom" class="section-block">
                <div class="glass-card p-4 sm:p-8 border-t-4 border-amber-400">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-amber-500 text-white rounded-xl flex items-center justify-center font-black shadow-lg shadow-amber-200">2</div>
                        <h2 class="text-2xl font-black text-amber-900">第二區：下半部造詞</h2>
                    </div>
                    <div class="flex flex-row gap-4 w-full">
                        <div class="relative w-1/2 group">
                            <input type="text" class="zhuyin-input warm-input w-full px-2 sm:px-6 py-4 rounded-2xl text-lg sm:text-xl text-center font-black cursor-pointer shadow-sm" placeholder="請選擇注音" readonly onclick="openZhuyinPicker(event, this)">
                            <i data-lucide="chevron-down" class="hidden sm:block absolute right-4 top-1/2 -translate-y-1/2 text-amber-300 group-hover:text-amber-500 transition-colors"></i>
                        </div>
                        <button onclick="handleSectionAction('section-bottom')" class="action-btn w-1/2 bg-gradient-to-br from-amber-400 to-amber-500 text-white py-4 rounded-2xl font-black text-base sm:text-lg shadow-lg shadow-amber-100 transition-all flex items-center justify-center gap-2 hover:-translate-y-0.5">
                            <i data-lucide="sparkles" class="w-4 h-4 sm:w-5 sm:h-5"></i> <span class="btn-text">產生造詞</span>
                        </button>
                    </div>
                    <div class="result-area hidden mt-4 pt-4 border-t border-amber-100/50">
                        <div class="word-grid grid grid-cols-4 gap-1.5 sm:gap-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 功能輸出按鈕區 -->
        <div class="grid grid-cols-2 gap-4 mb-12">
            <button onclick="exportAsImage()" id="export-img-btn" class="bg-emerald-500 text-white py-5 rounded-2xl hover:bg-emerald-600 transition-all font-black shadow-xl shadow-emerald-100 flex items-center justify-center gap-2 text-[13px] sm:text-lg">
                <i data-lucide="image" class="w-4 h-4 sm:w-5 sm:h-5"></i> 輸出圖片
            </button>
            <button onclick="toggleSettings(event)" class="bg-zinc-800 text-white py-5 rounded-2xl hover:bg-zinc-900 transition-all font-black shadow-xl shadow-zinc-200 flex items-center justify-center gap-2 text-[13px] sm:text-lg">
                <i data-lucide="settings-2" class="w-4 h-4 sm:w-5 sm:h-5"></i> 進階 API 設定
            </button>
            <button onclick="exportPracticeImage('section-top')" class="btn-sunset text-white py-5 rounded-2xl hover:opacity-90 transition-all font-black shadow-lg flex items-center justify-center gap-2 text-[13px] sm:text-lg">
                <i data-lucide="printer" class="w-4 h-4 sm:w-5 sm:h-5"></i> 第一區練習單輸出
            </button>
            <button onclick="exportPracticeImage('section-bottom')" class="btn-sunset text-white py-5 rounded-2xl hover:opacity-90 transition-all font-black shadow-lg flex items-center justify-center gap-2 text-[13px] sm:text-lg">
                <i data-lucide="printer" class="w-4 h-4 sm:w-5 sm:h-5"></i> 第二區練習單輸出
            </button>
        </div>

        <!-- API Input -->
        <div id="settings-area" class="hidden mb-12 p-8 glass-card">
            <div class="flex flex-col gap-4 text-center">
                <label class="text-orange-900 font-black text-xl flex items-center justify-center gap-2">
                    <i data-lucide="key" class="w-5 h-5 text-orange-500"></i> 請輸入 Gemini API 金鑰
                </label>
                <input type="password" id="user-api-key" class="warm-input px-6 py-4 rounded-2xl text-center font-bold text-lg shadow-inner" placeholder="在此貼上您的金鑰...">
            </div>
        </div>
    </div>

    <!-- 使用說明浮動視窗 (Modal) -->
    <div id="modal-overlay" onclick="toggleManual(event)">
        <div id="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6 border-b border-orange-100 pb-3 shrink-0">
                <h3 class="font-black text-orange-900 text-2xl flex items-center gap-2">
                    <i data-lucide="info" class="text-orange-500"></i> 使用說明
                </h3>
                <button onclick="toggleManual(event)" class="text-orange-300 hover:text-orange-500">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="space-y-6 text-base font-medium text-orange-900/80 leading-relaxed overflow-y-auto pr-2 custom-scrollbar">
                <div class="flex gap-4">
                    <span class="w-6 h-6 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xs font-bold shrink-0 mt-1">1</span>
                    <p><span class="text-orange-600 font-bold">隨機生成</span>：直接點擊按鈕，由 AI 或詞庫隨機挑選 8 個詞彙。</p>
                </div>
                <div class="flex gap-4">
                    <span class="w-6 h-6 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xs font-bold shrink-0 mt-1">2</span>
                    <p><span class="text-orange-600 font-bold">指定注音</span>：點擊輸入框選擇特定注音符號生成造詞。</p>
                </div>
                <div class="flex gap-4">
                    <span class="w-6 h-6 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xs font-bold shrink-0 mt-1">3</span>
                    <p><span class="text-orange-600 font-bold">練習單輸出</span>：可分區輸出注音練習單，採「直式造詞、橫式書寫練習」佈布局。</p>
                </div>
                <div class="flex gap-4">
                    <span class="w-6 h-6 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xs font-bold shrink-0 mt-1">4</span>
                    <div>
                        <p><span class="text-orange-600 font-bold">Gemini API 設定</span>：導入自己的 API 金鑰可開啟 AI 即時生成功能，這能讓造詞跳脫固定詞庫，獲取更豐富、現代化且與時俱進的內容。</p>
                        <ul class="text-[13px] bg-white/50 p-4 rounded-xl border border-orange-100 mt-3 space-y-2">
                            <li>• 前往 <a href="https://aistudio.google.com/" target="_blank" class="text-orange-600 underline font-bold">Google AI Studio</a> 登入並產生金鑰。</li>
                            <li>• 點擊下方「進階 API 設定」貼入金鑰即可啟用。</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="mt-8 shrink-0">
                <button onclick="toggleManual(event)" class="w-full py-4 bg-orange-500 text-white rounded-2xl font-black shadow-lg shadow-orange-200 hover:bg-orange-600 transition-all">
                    我知道了
                </button>
            </div>
        </div>
    </div>

    <div id="zhuyin-picker"></div>
    <!-- 擷取畫布隱藏區 -->
    <div id="capture-area"><div id="capture-content"></div></div>

    <script>
        // --- 核心資料與狀態 ---
        const allZhuyin = "ㄅㄆㄇㄈㄉㄊㄋㄌㄍㄎㄏㄐㄑㄒㄓㄔㄕㄖㄗㄘㄙㄚㄛㄜㄝㄞㄟㄠㄡㄢㄣㄤㄥㄦㄧㄨㄩ";
        const apiKey = ""; 

        const SMART_LIB = {
            'ㄅ': ['爸爸 ㄅㄚˋ ㄅㄚ˙', '杯子 ㄅㄟ ㄗ˙', '布丁 ㄅㄨˋ ㄉㄧㄥ', '白雲 ㄅㄞˊ ㄩㄣˊ', '鼻子 ㄅㄧˊ ㄗ˙', '包子 ㄅㄠ ㄗ˙', '筆記 ㄅㄧˇ ㄐㄧˋ', '冰箱 ㄅㄧㄥ ㄒㄧㄤ', '玻璃 ㄅㄛ ㄌㄧˊ', '餅乾 ㄅㄧㄥˇ ㄍㄢ'],
            'ㄆ': ['朋友 ㄆㄥˊ ㄧㄡˇ', '蘋果 ㄆㄧㄥˊ ㄍㄨㄛˇ', '皮球 ㄆㄧˊ ㄑㄧㄡˊ', '拍手 ㄆㄞ ㄕㄡˇ', '瀑布 ㄆㄨˋ ㄅㄨˋ', '盤子 ㄆㄢˊ ㄗ˙', '漂亮 ㄆㄧㄠˋ ㄌㄧㄤˋ', '皮包 ㄆㄧˊ ㄅㄠ', '平安 ㄆㄧㄥ ㄢ', '跑步 ㄆㄠˇ ㄅㄨˋ'],
            'ㄇ': ['媽媽 ㄇㄚ ㄇㄚ˙', '帽子 ㄇㄠˋ ㄗ˙', '妹妹 ㄇㄟˋ ㄇㄟ˙', '螞蟻 ㄇㄚˇ ㄧˇ', '門窗 ㄇㄣˊ ㄔㄨㄤ', '貓咪 ㄇㄠ ㄇㄧ', '麵包 ㄇㄧㄢˋ ㄅㄠ', '買菜 ㄇㄞˇ ㄘㄞˋ', '毛筆 ㄇㄠˊ ㄅㄧˇ', '秘密 ㄇㄧˋ ㄇㄧˋ'],
            'ㄈ': ['風車 ㄈㄥ ㄔㄜ', '飛機 ㄈㄟ ㄐㄧ', '房子 ㄈㄤˊ ㄗ˙', '父母 ㄈㄨˋ ㄇㄨˇ', '非常 ㄈㄟ ㄔㄤˊ', '方塊 ㄈㄤ ㄎㄨㄞˋ', '肥皂 ㄈㄟˊ ㄗㄠˋ', '分數 ㄈㄣ ㄕㄨˋ', '風景 ㄈㄥ ㄐㄧㄥˇ', '風扇 ㄈㄥ ㄕㄢˋ'],
            'ㄉ': ['弟弟 ㄉㄧˋ ㄉㄧ˙', '電視 ㄉㄧㄢˋ ㄕˋ', '打球 ㄉㄚˇ ㄑㄧㄡˊ', '地球 ㄉㄧˋ ㄑㄧˊ', '大樹 ㄉㄚˋ ㄕㄨˋ', '蛋糕 ㄉㄢˋ ㄍㄠ', '低頭 ㄉㄧ ㄊㄡˊ', '冬天 ㄉㄨㄥ ㄊㄧㄢ', '燈泡 ㄉㄥ ㄆㄠˋ', '豆漿 ㄉㄡˋ ㄐㄧㄤ'],
            'ㄊ': ['太陽 ㄊㄞˋ ㄧㄤˊ', '天空 ㄊㄧㄢ ㄎㄨㄥ', '跳舞 ㄊㄧㄠˋ ㄨˇ', '糖果 ㄊㄤˊ ㄍㄨㄛˇ', '體操 ㄊㄧˇ ㄘㄠ', '兔子 ㄊㄨˋ ㄗ˙', '特別 ㄊㄜˋ ㄅㄧㄝˊ', '鐵路 ㄊㄧㄝˇ ㄌㄨˋ', '台階 ㄊㄞˊ ㄐㄧㄝ', '停車 ㄊㄧㄥ ㄔㄜ'],
            'ㄋ': ['牛奶 ㄋㄧㄡˊ ㄋㄞˇ', '奶奶 ㄋㄞˇ ㄋㄞ˙', '南瓜 ㄋㄢˊ ㄍㄨㄚ', '泥土 ㄋㄧˊ ㄊㄨˇ', '能力 ㄋㄥˊ ㄌㄧˋ', '內容 ㄋㄟˋ ㄖㄨㄥˊ', '哪裡 ㄋㄚˇ ㄌㄧˇ', '女生 ㄋㄩˇ ㄕㄥ', '努力 ㄋㄨˇ ㄌㄧˋ', '念書 ㄋㄧㄢˋ ㄕㄨ'],
            'ㄌ': ['老師 ㄌㄠˇ ㄕ', '籃球 ㄌㄢˊ ㄑㄧㄡˊ', '月亮 ㄩㄝˋ ㄌㄧㄤˋ', '梨子 ㄌㄧˊ ㄗ˙', '禮物 ㄌㄧˇ ㄨˋ', '喇叭 ㄌㄚˇ ㄅㄚ', '力量 ㄌㄧˋ ㄌㄧㄤˋ', '路燈 ㄌㄨˋ ㄉㄥ', '立刻 ㄌㄧˋ ㄎㄜˋ', '輪子 ㄌㄨㄣˊ ㄗ˙'],
            'ㄍ': ['哥哥 ㄍㄜ ㄍㄜ˙', '公園 ㄍㄨㄥ ㄩㄢˊ', '故事 ㄍㄨˋ ㄕˋ', '西瓜 ㄒㄧ ㄍㄨㄚ', '國旗 ㄍㄨㄛˊ ㄑㄧˊ', '乖巧 ㄍㄨㄞ ㄑㄧㄠˇ', '工作 ㄍㄨㄥ ㄗㄨㄛˋ', '公共 ㄍㄨㄥ ㄍㄨㄥˋ', '鋼琴 ㄍㄤ ㄑㄧㄣˊ', '廣告 ㄍㄨㄤˇ ㄍㄠˋ'],
            'ㄎ': ['開水 ㄎㄞ ㄕㄨㄟˇ', '口袋 ㄎㄡˇ ㄉㄞˋ', '看書 ㄎㄢˋ ㄕㄨ', '烤肉 ㄎㄠˇ ㄖㄡˋ', '科學 ㄎㄜ ㄒㄩㄝˊ', '困難 ㄎㄨㄣˋ ㄋㄢˊ', '客廳 ㄎㄜˋ ㄊㄧㄥ', '空氣 ㄎㄨㄥ ㄑㄧˋ', '苦瓜 ㄎㄨˇ ㄍㄨㄚ', '快慢 ㄎㄨㄞˋ ㄇㄢˋ'],
            'ㄏ': ['喝水 ㄏㄜ ㄕㄨㄟˇ', '河流 ㄏㄜˊ ㄌㄧㄡˊ', '蝴蝶 ㄏㄨˊ ㄉㄧㄝˊ', '好人 ㄏㄠˇ ㄖㄣˊ', '花朵 ㄏㄨㄚ ㄉㄨㄛˇ', '火車 ㄏㄨㄛˇ ㄔㄜ', '海洋 ㄏㄞˇ ㄧㄤˊ', '回家 ㄏㄨㄟˊ ㄐㄧㄚ', '後面 ㄏㄡˋ ㄇㄧㄢˋ', '紅包 ㄏㄨㄥˊ ㄅㄠ'],
            'ㄐ': ['記者 ㄐㄧˋ ㄓㄜˇ', '簡單 ㄐㄧㄢˇ ㄉㄢ', '家人 ㄐㄧㄚ ㄖㄣˊ', '雞蛋 ㄐㄧ ㄉㄢˋ', '進步 ㄐㄧㄣˋ ㄅㄨˋ', '健康 ㄐㄧㄢˋ ㄎㄤ', '警察 ㄐㄧㄥˇ ㄔㄚˊ', '鏡子 ㄐㄧㄥˋ ㄗ˙', '加上 ㄐㄧㄚ ㄕㄤˋ', '景色 ㄐㄧㄥˇ ㄙㄜˋ'],
            'ㄑ': ['秋天 ㄑㄧㄡ ㄊㄧㄢ', '氣球 ㄑㄧˋ ㄑㄧㄡˊ', '前面 ㄑㄧㄢˊ ㄇㄧㄢˋ', '蜻廷 ㄑㄧㄥ ㄊㄧㄥˊ', '清潔 ㄑㄧㄥ ㄐㄧㄝˊ', '企鵝 ㄑㄧˋ ㄜˊ', '汽車 ㄑㄧˋ ㄔㄜ', '請問 ㄑㄧㄥˇ ㄨㄣˋ', '奇怪 ㄑㄧˊ ㄍㄨㄞˋ', '期待 ㄑㄧˊ ㄉㄞˋ'],
            'ㄒ': ['學校 ㄒㄩㄝˊ ㄒㄧㄠˋ', '小雞 ㄒㄧㄠˇ ㄐㄧ', '喜歡 ㄒㄧˇ ㄏㄨㄢ', '洗手 ㄒㄧˇ ㄕㄡˇ', '辛苦 ㄒㄧㄣ ㄎㄨˇ', '西瓜 ㄒㄧ ㄍㄨㄚ', '休息 ㄒㄧㄡ ㄒㄧˊ', '希望 ㄒㄧ ㄨㄤˋ'],
            'ㄓ': ['知道 ㄓ ㄉㄠˋ', '中午 ㄓㄨㄥ ㄨˇ', '種植 ㄓㄨㄥˋ ㄓˊ', '真誠 ㄓㄣ ㄔㄥˊ', '準備 ㄓㄨㄣˇ ㄅㄟˋ', '紙張 ㄓˇ ㄓㄤ', '整理 ㄓㄥˇ ㄌㄧˇ', '重要 ㄓㄨㄥˋ ㄧㄠˋ', '蜘蛛 ㄓ ㄓㄨ', '指甲 ㄓˇ ㄐㄧㄚˇ'],
            'ㄔ': ['吃飯 ㄔ ㄈㄢˋ', '春天 ㄔㄨㄣ ㄊㄧㄢ', '出發 ㄔㄨ ㄈㄚ', '成功 ㄔㄥˊ ㄍㄨㄥ', '車子 ㄔㄜ ㄗ˙', '嘗試 ㄔㄤˊ ㄕˋ', '窗戶 ㄔㄨㄤ ㄏㄨˋ', '長度 ㄔㄤˊ ㄉㄨˋ', '唱歌 ㄔㄤˋ ㄍㄜ', '超過 ㄔㄠ ㄍㄨㄛˋ'],
            'ㄕ': ['手錶 ㄕㄡˇ ㄅㄧㄠˇ', '水果 ㄕㄨㄟˇ ㄍㄨㄛˇ', '書本 ㄕㄨ ㄅㄣˇ', '山上 ㄕㄢ ㄕㄤˋ', '身上 ㄕㄣ ㄕㄤˋ', '樹木 ㄕㄨˋ ㄇㄨˋ', '世界 ㄕˋ ㄐㄧㄝˋ', '收穫 ㄕㄡ ㄏㄨㄛˋ', '時間 ㄕˊ ㄐㄧㄢ', '生日 ㄕㄥ ㄖˋ'],
            'ㄖ': ['日本 ㄖˋ ㄅㄣˇ', '日記 ㄖˋ ㄐㄧˋ', '日常 ㄖˋ ㄔㄤˊ', '如何 ㄖㄨˊ ㄏㄜˊ', '如果 ㄖㄨˊ ㄍㄨㄛˇ', '人員 ㄖㄣˊ ㄩㄢˊ', '認真 ㄖㄣˋ ㄓㄣ', '熱鬧 ㄖㄜˋ ㄋㄠˋ', '肉類 ㄖㄡˋ ㄌㄟˋ', '任何 ㄖㄣˋ ㄏㄜˊ'],
            'ㄗ': ['早上 ㄗㄠˇ ㄕㄤˋ', '做工 ㄗㄨㄛˋ ㄍㄨㄥ', '自大 ㄗˋ ㄉㄚˋ', '自由 ㄗˋ ㄧㄡˊ', '走路 ㄗㄡˇ ㄌㄨˋ', '足夠 ㄗㄨˊ ㄍㄡˋ', '字典 ㄗˋ ㄉㄧㄢˇ', '自己 ㄗˋ ㄐㄧˇ', '左邊 ㄗㄨㄛˇ ㄅㄧㄢ', '昨天 ㄗㄨㄛˊ ㄊㄧㄢ'],
            'ㄘ': ['草地 ㄘㄠˇ ㄉㄧˋ', '彩虹 ㄘㄞˇ ㄏㄨㄥˊ', '測驗 ㄘㄜˋ ㄧㄢˋ', '曾經 ㄘㄥˊ ㄐㄧㄥ', '操場 ㄘㄠ ㄔㄤˇ', '層次 ㄘㄥˊ ㄘˋ', '材料 ㄘㄞˊ ㄌㄧㄠˋ', '次序 ㄘˋ ㄒㄩˋ', '餐廳 ㄘㄢ ㄊㄧㄥ', '匆忙 ㄘㄨㄥ ㄇㄤˊ'],
            'ㄙ': ['思考 ㄙ ㄎㄠˇ', '四方 ㄙˋ ㄈㄤ', '速食 ㄙㄨˋ ㄕˊ', '司機 ㄙ ㄐㄧ', '森林 ㄙㄣ ㄌㄧㄣˊ', '送禮 ㄙㄨㄥˋ ㄌㄧˇ', '塑膠 ㄙㄨˋ ㄐㄧㄠ', '宿舍 ㄙㄨˋ ㄕㄜˋ', '雖然 ㄙㄨㄟ ㄖㄢˊ', '所以 ㄙㄨㄛˇ ㄧˇ'],
            'ㄚ': ['阿姨 ㄚ ㄧˊ', '大家 ㄉㄚˋ ㄐㄧㄚ', '增加 ㄗㄥ ㄐㄧㄚ', '鴨子 ㄧㄚ ㄗ˙', '打雷 ㄉㄚˇ ㄌㄟˊ', '拉開 ㄌㄚ ㄎㄞ', '怕黑 ㄆㄚˋ ㄏㄟ', '哈哈 ㄏㄚ ㄏㄚ', '沙發 ㄕㄚ ㄈㄚ', '下巴 ㄒㄧㄚˋ ㄅㄚ'],
            'ㄛ': ['菠菜 ㄅㄛ ㄘㄞˋ', '播報 ㄅㄛ ㄅㄠˋ', '磨合 ㄇㄛˊ ㄏㄜˊ', '潑水 ㄆㄛ ㄕㄨㄟˇ', '破壞 ㄆㄛˋ ㄏㄨㄞˋ', '佛經 ㄈㄛˊ ㄐㄧㄥ', '薄膜 ㄅㄛˊ ㄇㄛˊ', '果凍 ㄍㄨㄛˇ ㄉㄨㄥˋ', '左手 ㄗㄨㄛˇ ㄕㄡˇ', '婆婆 ㄆㄛˊ ㄆㄛˊ'],
            'ㄜ': ['特色 ㄊㄜˋ ㄙㄜˋ', '河邊 ㄏㄜˊ ㄅㄧㄢ', '熱量 ㄖㄜˋ ㄌㄧㄤˋ', '值得 ㄓˊ ㄉㄜ˙', '測量 ㄘㄜˋ ㄌㄧㄤˊ', '刻苦 ㄎㄜˋ ㄎㄨˇ', '鵝蛋 ㄜˊ ㄉㄢˋ', '惡習 ㄜˋ ㄒㄧˊ', '合適 ㄏㄜˊ ㄕˋ', '隔壁 ㄍㄜˊ ㄅㄧˋ'],
            'ㄝ': ['爺爺 ㄧㄝˊ ㄧㄝ˙', '寫字 ㄒㄧㄝˇ ㄗˋ', '鞋子 ㄒㄧㄝˊ ㄗ˙', '謝謝 ㄒㄧㄝˋ ㄒㄧㄝ˙', '姐姐 ㄐㄧㄝˇ ㄐㄧㄝˇ', '咧嘴 ㄌㄧㄝˇ ㄗㄨㄟˇ', '夜晚 ㄧㄝˋ ㄨㄢˇ', '蝴蝶 ㄏㄨˊ ㄉㄧㄝˊ', '解散 ㄐㄧㄝˇ ㄙㄢˋ', '斜坡 ㄒㄧㄝˊ ㄆㄛ'],
            'ㄞ': ['愛心 ㄞˋ ㄒㄧㄣ', '矮小 ㄞˇ ㄒㄧㄠˇ', '應該 ㄧㄥ ㄍㄞ', '徘徊 ㄆㄞˊ ㄏㄨㄞˊ', '拍賣 ㄆㄞ ㄇㄞˋ', '外國 ㄨㄞˋ ㄍㄨㄛˊ', '害蟲 ㄏㄞˋ ㄔㄨㄥˊ', '來到 ㄌㄞˊ ㄉㄠˋ', '彩色 ㄘㄞˇ ㄙㄜˋ', '拆除 ㄔㄞ ㄔㄨˊ'],
            'ㄟ': ['飛機 ㄈㄟ ㄐㄧ', '累積 ㄌㄟˇ ㄐㄧ', '杯子 ㄅㄟ ㄗ˙', '背後 ㄅㄟˋ ㄏㄡˋ', '歸類 ㄍㄨㄟ ㄌㄟˋ', '配音 ㄆㄟˋ ㄧㄣ', '沒有 ㄇㄟˊ ㄧㄡˇ', '對面 ㄉㄨㄟˋ ㄇㄧㄢˋ', '推開 ㄊㄨㄟ ㄎㄞ', '內容 ㄋㄟˋ ㄖㄨㄥˊ'],
            'ㄠ': ['驕傲 ㄐㄧㄠ ㄠˋ', '凹洞 ㄠ ㄉㄨㄥˋ', '宣告 ㄒㄩㄢ ㄍㄠˋ', '考試 ㄎㄠˇ ㄕˋ', '懊悔 ㄠˋ ㄏ維', '包含 ㄅㄠ ㄏㄢˊ', '跑步 ㄆㄠˇ ㄅㄨˋ', '來到 ㄌㄞˊ ㄉㄠˋ', '掃地 ㄙㄠˇ ㄉㄧˋ', '包子 ㄅㄠ ㄗ˙'],
            'ㄡ': ['歐美 ㄡ ㄇㄟˇ', '海鷗 ㄏㄞˇ ㄡ', '偶像 ㄡˇ ㄒㄧㄤˋ', '扣子 ㄎㄡˋ ㄗ˙', '後悔 ㄏㄡˋ ㄏㄨㄟˇ', '都有 ㄉㄡ ㄧㄡˇ', '透過 ㄊㄡˋ ㄍㄨㄛˋ', '肉片 ㄖㄡˋ ㄆㄧㄢˋ', '救命 ㄐㄧㄡˋ ㄇㄧㄥˋ', '狗狗 ㄍㄨˇ ㄍㄡˇ'],
            'ㄢ': ['安靜 ㄢ ㄐㄧㄥˋ', '暗號 ㄢˋ ㄏㄠˋ', '岸邊 ㄢˋ ㄅㄧㄢ', '答案 ㄉㄚˊ ㄢˋ', '安排 ㄢ ㄆㄞˊ', '搬家 ㄅㄢ ㄐㄧㄚ', '盤子 ㄆㄢˊ ㄗ˙', '方面 ㄈㄤ ㄇㄧㄢˋ', '男聲 ㄋㄢˊ ㄕㄥ', '藍色 ㄌㄢˊ ㄙㄜˋ'],
            'ㄣ': ['恩人 ㄣ ㄖㄣˊ', '感恩 ㄍㄢˇ ㄣ', '根本 ㄍㄣ ㄅㄣˇ', '噴泉 ㄆㄣ ㄑㄩㄢˊ', '本身 ㄅㄣˇ ㄕㄣ', '盆栽 ㄆㄣˊ ㄗㄞ', '門鈴 ㄇㄣˊ ㄌㄧㄥˊ', '等到 ㄉㄥˇ ㄉㄠˋ', '準備 ㄓㄨㄣˇ ㄅㄟˋ', '南部 ㄋㄧㄢˊ ㄅㄨˋ'],
            'ㄤ': ['骯髒 ㄤ ㄗㄤ', '高昂 ㄍㄠ ㄤˊ', '手槍 ㄕㄡˇ ㄑㄧㄤ', '鋼琴 ㄍㄤ ㄑㄧㄣˊ', '胖子 ㄆㄤˋ ㄗ˙', '忙碌 ㄇㄤˊ ㄌㄨˋ', '方向 ㄈㄤ ㄒㄧㄤˋ', '文章 ㄨㄣˊ ㄓㄤ', '糖果 ㄊㄤˊ ㄍㄨㄛˇ', '陽光 ㄧㄤˊ ㄍㄨㄤ'],
            'ㄥ': ['風車 ㄈㄥ ㄔㄜ', '燈泡 ㄉㄥ ㄆㄠˋ', '冷靜 ㄌㄥˇ ㄐㄧㄥˋ', '能量 ㄋㄥˊ ㄌㄧˋ', '增加 ㄗㄥ ㄐㄧㄚ', '棚架 ㄆㄥˊ ㄐㄧㄚˋ', '蒙古 ㄇㄥˊ ㄍㄨˇ', '曾經 ㄘㄥˊ ㄐㄧㄥ', '豐收 ㄈㄥ ㄕㄡ', '姓名 ㄒㄧㄥˋ ㄇㄧㄥˊ'],
            'ㄦ': ['兒子 ㄦˊ ㄗ˙', '兒童 ㄦˊ ㄊㄨㄥˊ', '耳環 ㄦˇ ㄏㄨㄢˊ', '二胡 ㄦˋ ㄏㄨˊ', '而去 ㄦˊ ㄑㄩˋ', '幼兒 ㄧㄡˋ ㄦˊ', '孤兒 ㄍㄨ ㄦˊ', '兒歌 ㄦˊ ㄍㄜ', '而且 ㄦˊ ㄑㄧㄝˇ', '耳朵 ㄦˇ ㄉㄨㄛ˙'],
            'ㄧ': ['醫生 ㄧ ㄕㄥ', '衣櫃 ㄧ ㄍㄨㄟˋ', '一起 ㄧ ㄑㄧˇ', '意見 ㄧˋ ㄐㄧㄢˋ', '意外 ㄧˋ ㄨㄞˋ', '筆畫 ㄅㄧˇ ㄏㄨㄚˋ', '奇怪 ㄑㄧˊ ㄍㄨㄞˋ', '希望 ㄒㄧ ㄨㄤˋ', '以此 ㄧˇ ㄘˇ', '衣服 ㄧ ㄈㄨˊ'],
            'ㄨ': ['屋頂 ㄨ ㄉㄧㄥˇ', '污泥 ㄨ ㄋㄧˊ', '無線 ㄨˊ ㄒㄧㄢˋ', '污染 ㄨ ㄖㄢˇ', '武器 ㄨˇ ㄑㄧˋ', '不但 ㄅㄨˊ ㄉㄢˋ', '瀑布 ㄆㄨˋ ㄅㄨˋ', '舒服 ㄕㄨ ㄈㄨˊ', '烏鴉 ㄨ ㄧㄚ', '故意 ㄍㄨˋ ㄧˋ'],
            'ㄩ': ['月亮 ㄩㄝˋ ㄌㄧㄤˋ', '玉米 ㄩˋ ㄇㄧˇ', '雨衣 ㄩˇ ㄧ', '語言 ㄩˇ ㄧㄢˊ', '浴室 ㄩˋ ㄕˋ', '魚缸 ㄩˊ ㄍㄤ', '宇宙 ㄩˇ ㄓㄡ', '愉快 ㄩˊ ㄎㄨㄞˋ', '遇到 ㄩˋ ㄉㄠˋ', '許多 ㄒㄩˇ ㄉㄨㄛ']
        };

        let sectionState = {
            'section-top': { words: [], status: '隨機', val: '' },
            'section-bottom': { words: [], status: '隨機', val: '' }
        };

        // --- UI 互動邏輯 ---
        function toggleManual(e) { 
            if (e) e.stopPropagation(); 
            const overlay = document.getElementById('modal-overlay');
            if (overlay.style.display === 'flex') {
                overlay.style.display = 'none';
            } else {
                overlay.style.display = 'flex';
            }
        }

        function toggleSettings(e) { e.stopPropagation(); document.getElementById('settings-area').classList.toggle('hidden'); }
        
        function closeAllPickers() { 
            const picker = document.getElementById('zhuyin-picker');
            if (picker) picker.style.display = 'none'; 
        }

        function openZhuyinPicker(e, inputEl) {
            e.stopPropagation();
            const picker = document.getElementById('zhuyin-picker');
            const rect = inputEl.getBoundingClientRect();
            picker.innerHTML = '';
            allZhuyin.split('').forEach(char => {
                const key = document.createElement('div');
                key.className = 'picker-key';
                key.innerText = char;
                key.onclick = (ev) => {
                    ev.stopPropagation();
                    inputEl.value = char;
                    inputEl.closest('.section-block').querySelector('.btn-text').innerText = "產生造詞";
                    picker.style.display = 'none';
                };
                picker.appendChild(key);
            });
            picker.style.display = 'grid';
            let left = rect.left + window.scrollX;
            if (left + 380 > window.innerWidth) left = window.innerWidth - 400;
            picker.style.top = `${rect.bottom + window.scrollY + 10}px`;
            picker.style.left = `${Math.max(10, left)}px`;
        }

        async function handleSectionAction(sectionId) {
            const section = document.getElementById(sectionId);
            const input = section.querySelector('.zhuyin-input').value.trim();
            const btnText = section.querySelector('.btn-text');
            const userKey = document.getElementById('user-api-key').value.trim();
            const otherId = sectionId === 'section-top' ? 'section-bottom' : 'section-top';
            const existing = sectionState[otherId].words.map(w => typeof w === 'string' ? w.split(' ')[0] : w.text);

            const oldText = btnText.innerText; btnText.innerHTML = `<div class="loader mx-auto"></div>`;

            if (apiKey || userKey) {
                try {
                    let prompt = input ? `針對注音『${input}』生成 8 個常用的造詞。` : `隨機挑選注音生成 8 個常用的造詞。`;
                    prompt += ` 條件：2個字，不可包含 [${existing.join(', ')}]。JSON格式：{"words": [{"text": "...", "zhuyin": "..."}]}`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey || userKey}`, { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } }) 
                    });
                    const result = await res.json();
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    const finalWords = data.words.filter(w => w.text.length === 2).slice(0, 8);
                    sectionState[sectionId] = { words: finalWords, status: input ? '指定' : '隨機', val: input };
                    renderToSection(sectionId, finalWords); btnText.innerText = oldText; return;
                } catch (e) { console.error("AI 生成失敗"); }
            }

            let source = (typeof EXTENDED_WORDS !== 'undefined') ? EXTENDED_WORDS : SMART_LIB;
            let pool = input ? (source[input] || []) : Object.values(source).flat();
            let resultWords = pool.filter(w => w.split(' ')[0].length === 2 && !existing.includes(w.split(' ')[0])).sort(() => 0.5 - Math.random()).slice(0, 8);
            
            sectionState[sectionId] = { words: resultWords, status: input ? '指定' : '隨機', val: input };
            renderToSection(sectionId, resultWords); btnText.innerText = oldText;
        }

        function renderToSection(sectionId, words) {
            const grid = document.getElementById(sectionId).querySelector('.word-grid');
            grid.innerHTML = '';
            words.forEach(item => {
                const text = typeof item === 'string' ? item.split(' ')[0] : item.text;
                const zyRaw = typeof item === 'string' ? item.split(' ').slice(1) : item.zhuyin.split(' ');
                const card = document.createElement('div');
                card.className = "bg-white border-2 border-orange-200 rounded-2xl shadow-md p-1 sm:p-4 flex items-center justify-center";
                let html = `<div class="word-container">`;
                text.split('').forEach((char, i) => {
                    const zyStr = zyRaw[i] || ""; let symbols = '', tone = '', toneClass = '';
                    for (let c of zyStr) {
                        if (['ˊ', 'ˇ', 'ˋ'].includes(c)) { tone = c; toneClass = 'tone-side'; }
                        else if (c === '˙') { tone = c; toneClass = 'tone-top'; }
                        else { symbols += `<span class="block">${c}</span>`; }
                    }
                    html += `<div class="char-unit"><div class="zhuyin-wrapper"><div class="zhuyin-symbols">${symbols}${tone ? `<div class="${toneClass}">${tone}</div>` : ''}</div></div><div class="char-text">${char}</div></div>`;
                });
                html += `</div>`; card.innerHTML = html; grid.appendChild(card);
            });
            document.getElementById(sectionId).querySelector('.result-area').classList.remove('hidden');
        }

        // --- 渲染輸出邏輯 (正式圖片) ---
        function renderFormalDocument() {
            const content = document.getElementById('capture-content');
            const area = document.getElementById('capture-area');
            area.style.width = "1000px"; area.style.height = "1414px"; area.style.padding = "40px";
            area.style.background = "#fffcf0"; 
            content.innerHTML = `<div style="text-align:center; font-size:46px; font-weight:900; margin-top:10px; margin-bottom:20px; color:#433422; font-family:'Noto Serif TC', serif;">注音造詞練習單</div>`;
            const addFormal = (id, title) => {
                const data = sectionState[id]; if (!data.words.length) return;
                const head = document.createElement('div');
                head.style.cssText = `border-bottom:4px solid #ff8c42; margin-top:${id==='section-bottom'?'25px':'5px'}; margin-bottom:15px; width:100%; font-size:30px; font-weight:900; padding-bottom:20px; color:#433422; font-family:'Noto Serif TC', serif;`;
                head.innerText = `${title} ${data.status==='隨機'?'隨機生成造詞':'['+data.val+'] 的造詞練習'}`;
                content.appendChild(head);
                const grid = document.createElement('div');
                grid.style.cssText = "display:grid; grid-template-columns:repeat(4, 1fr); gap:15px 20px; width:100%;";
                data.words.forEach(item => {
                    const box = document.createElement('div');
                    box.style.cssText = "display:flex; flex-direction:column; align-items:center; justify-content:center; padding:10px; height:240px; background:#ffffff; border:3px solid #f9ebbe; border-radius:40px; overflow:visible;";
                    const text = typeof item === 'string' ? item.split(' ')[0] : item.text;
                    const zyRaw = typeof item === 'string' ? item.split(' ').slice(1) : item.zhuyin.split(' ');
                    text.split('').forEach((char, i) => {
                        const row = document.createElement('div');
                        row.style.cssText = "display:flex; flex-direction:row; align-items:center; justify-content:center; height:110px; width:100%; margin-bottom:5px;";
                        const cEl = document.createElement('div'); cEl.innerText = char;
                        cEl.style.cssText = `font-family:'Noto Serif TC', serif; font-weight:700; font-size:4.0rem; color:#000; margin-right:15px; display:flex; align-items:center; height:100px; margin-top:-58px;`;
                        const zBox = document.createElement('div');
                        zBox.style.cssText = "position:relative; width:45px; height:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; margin-top:-22px;";
                        const zSym = document.createElement('div'); zSym.style.cssText = "display:flex; flex-direction:column; align-items:center; font-size:1.6rem; font-weight:bold; color:#d35400; line-height:1.1; font-family:'Noto Serif TC', serif;";
                        const zy = zyRaw[i] || ""; let s="", t="", tc="";
                        for(let c of zy){ if(['ˊ','ˇ','ˋ'].includes(c)){t=c;tc="side";}else if(c==='˙'){t=c;tc="top";}else{s+=`<span style="display:block;">${c}</span>`;} }
                        zSym.innerHTML = s; zBox.appendChild(zSym);
                        if(t){ const tEl = document.createElement('div'); tEl.innerText = t; tEl.style.cssText = `position:absolute; color:#2563eb; font-weight:900; ${tc==='side'?'right:-12px; top:50%; transform:translateY(-50%); font-size:1.5rem;':'top:-12px; left:50%; transform:translateX(-50%); font-size:1.6rem;'}`; zBox.appendChild(tEl); }
                        row.appendChild(cEl); row.appendChild(zBox); box.appendChild(row);
                    });
                    grid.appendChild(box);
                });
                content.appendChild(grid);
            };
            addFormal('section-top', "第一區"); addFormal('section-bottom', "第二區");
        }

        // --- 渲染輸出邏輯 (練習單) ---
        function renderPracticeDocument(id) {
            const content = document.getElementById('capture-content');
            const area = document.getElementById('capture-area');
            area.style.width = "1414px"; area.style.height = "1000px"; area.style.padding = "30px 40px";
            area.style.background = "#fffcf0"; 
            const data = sectionState[id]; const label = id==='section-top'?"第一區":"第二區";
            content.innerHTML = `<div style="text-align:center; font-size:46px; font-weight:900; margin-bottom:20px; color:#433422; font-family:'Noto Serif TC', serif;">注音符號手寫練習單 <span style="font-size: 26px; font-weight: 700; color: #7f6e5d; margin-left: 10px;">(${label} ${data.status}生成造詞)</span></div><div style="border-bottom:4px solid #ff8c42; margin-bottom:20px; width:100%; height:10px;"></div>`;
            const grid = document.createElement('div'); grid.style.cssText = "display:grid; grid-template-columns:repeat(4, 1fr); gap:12px 12px; width:100%;";
            data.words.forEach(item => {
                const box = document.createElement('div'); 
                box.style.cssText = "display:flex; flex-direction:column; align-items:center; justify-content:center; padding:10px 5px; background:#ffffff; border:3px solid #f9ebbe; border-radius:30px; gap:15px; min-height:410px; box-shadow:0 4px 6px -1px rgba(139, 69, 19, 0.05);";
                const text = typeof item === 'string' ? item.split(' ')[0] : item.text;
                const zyRaw = typeof item === 'string' ? item.split(' ').slice(1) : item.zhuyin.split(' ');
                text.split('').forEach((char, i) => {
                    const row = document.createElement('div'); row.style.cssText = "display:flex; flex-direction:row; align-items:center; gap:6px; height:160px;";
                    const buildPracticeBox = (isT) => {
                        const b = document.createElement('div'); 
                        b.style.cssText = `width:92px; height:160px; border:${isT?'1.5px solid #f9ebbe':'2px dashed #f3e5ab'}; border-radius:15px; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; background:${isT?'#fff9e6':'transparent'};`;
                        if(!isT){ 
                            b.innerHTML = `<div style="position:absolute; top:50%; left:0; width:100%; border-top:1px dashed #f3e5ab;"></div><div style="position:absolute; top:0; left:50%; height:100%; border-left:1px dashed #f3e5ab;"></div>`; 
                        }
                        else {
                            const zS = document.createElement('div'); 
                            const zy = zyRaw[i] || ""; let s="", t="", tc="";
                            for(let c of zy){ 
                                if(['ˊ','ˇ','ˋ'].includes(c)){t=c;tc="side";}
                                else if(c==='˙'){t=c;tc="top";}
                                else{s+=`<span style="display:block;">${c}</span>`;} 
                            }
                            const needsOffset = (tc === "side");
                            zS.style.cssText = `display:flex; flex-direction:column; align-items:center; font-family:'Noto Serif TC', serif; font-size:2.4rem; font-weight:bold; color:#fbd38d; line-height:1.05; margin-top:-20px; transition: none; transform: ${needsOffset ? 'translateX(-15px)' : 'translateX(0)'};`;
                            zS.innerHTML = s; b.appendChild(zS);
                            if(t){ 
                                const tE = document.createElement('div'); tE.innerText = t; 
                                tE.style.cssText = `position:absolute; color:#93c5fd; font-weight:900; ${tc==='side'?'right:12px; top:50%; transform:translateY(-50%); font-size:1.8rem;':'top:-12px; left:50%; transform:translateX(-50%); font-size:1.9rem;'}`; 
                                b.appendChild(tE); 
                            }
                        }
                        return b;
                    };
                    row.appendChild(buildPracticeBox(true)); row.appendChild(buildPracticeBox(false)); row.appendChild(buildPracticeBox(false)); box.appendChild(row);
                });
                grid.appendChild(box);
            });
            content.appendChild(grid);
        }

        // --- 匯出功能 ---
        async function exportAsImage() {
            if (!sectionState['section-top'].words.length && !sectionState['section-bottom'].words.length) return alert("請先產生造詞");
            renderFormalDocument(); await performCapture(`造詞單_${Date.now()}.png`, 1000, 1414);
        }
        async function exportPracticeImage(sectionId) {
            if (!sectionState[sectionId].words.length) return alert("該區域無造詞");
            renderPracticeDocument(sectionId); 
            const label = sectionId === 'section-top' ? "第一區" : "第二區";
            await performCapture(`練習單_${label}_${Date.now()}.png`, 1414, 1000);
        }
        async function performCapture(n, w, h) {
            try {
                const canvas = await html2canvas(document.getElementById('capture-area'), { scale: 2, useCORS: true, width: w, height: h, onclone: (d) => d.getElementById('capture-area').style.left = "0" });
                const l = document.createElement('a'); l.download = n; l.href = canvas.toDataURL(); l.click();
            } catch (e) { alert("輸出失敗"); }
        }

        // --- 初始化 ---
        window.onload = function() {
            lucide.createIcons();
        };
    </script>
</body>
</html>