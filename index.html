<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ³¨éŸ³é€ è©ç”¢ç”Ÿå™¨ - å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- è‡ªå‹•é€£çµå¤–éƒ¨è³‡æ–™åº«æª”æ¡ˆ -->
    <script src="zhuyin_data.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Noto+Serif+TC:wght@600;900&display=swap');
        
        :root {
            --char-size: 3.5rem;
            --unit-height: 105px;
            --zhuyin-font: 1.25rem;
        }

        @media (max-width: 640px) {
            :root {
                --char-size: 1.65rem;
                --unit-height: 65px;
                --zhuyin-font: 0.85rem;
            }
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
            -webkit-tap-highlight-color: transparent;
        }

        /* ç¶²é é è¦½ CSS */
        .word-container { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .char-unit { display: flex; flex-direction: row-reverse; align-items: center; justify-content: center; height: var(--unit-height); margin-bottom: 2px; }
        .char-text { font-family: 'Noto Serif TC', serif; font-size: var(--char-size); font-weight: 900; line-height: 1; display: flex; align-items: center; justify-content: center; width: calc(var(--char-size) * 1.1); height: var(--unit-height); color: #1e293b; }
        .zhuyin-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; height: var(--unit-height); width: calc(var(--zhuyin-font) * 2.4); margin-left: 1px; }
        .zhuyin-symbols { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: var(--zhuyin-font); line-height: 1.1; color: #2563eb; font-weight: bold; }
        
        .tone-side { position: absolute; right: -10px; top: 50%; transform: translateY(-50%); font-size: calc(var(--zhuyin-font) * 1.05); color: #ef4444; }
        @media (max-width: 640px) { .tone-side { right: -6px; font-size: 0.8rem; } }
        .tone-top { position: absolute; top: 2px; left: 50%; transform: translateX(-50%); font-size: calc(var(--zhuyin-font) * 1.15); color: #ef4444; font-weight: 900; }

        /* éš±è—çš„æ“·å–ç•«å¸ƒå€åŸŸ */
        #capture-area {
            width: 1000px;
            height: 1414px;
            background: #ffffff;
            position: absolute;
            left: -9999px;
            top: 0;
            padding: 40px 60px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* æ³¨éŸ³é»é¸å™¨é¢æ¿ */
        #zhuyin-picker {
            display: none;
            position: absolute;
            z-index: 2000;
            background: white;
            border: 2px solid #cbd5e1;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 16px;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            width: auto;
            max-width: 95vw;
        }
        @media (max-width: 640px) { #zhuyin-picker { grid-template-columns: repeat(6, 1fr); padding: 12px; gap: 6px; } }
        .picker-key { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: #f1f5f9; border-radius: 10px; font-weight: 900; color: #1d4ed8; cursor: pointer; transition: all 0.2s; border: 1px solid #e2e8f0; font-size: 1.2rem; }
        .picker-key:hover { background: #dbeafe; border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3b82f6; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen py-4 sm:py-6 px-4 relative" onclick="closeAllPickers()">
    
    <div class="max-w-5xl mx-auto">
        <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡èªªæ˜æŒ‰éˆ• -->
        <div class="relative text-center mb-8 sm:mb-10">
            <h1 class="text-3xl sm:text-5xl font-black text-blue-900 tracking-tight px-12">æ³¨éŸ³é€ è©ç”¢ç”Ÿå™¨</h1>
            
            <div id="help-btn-container" class="absolute right-0 top-1/2 -translate-y-1/2 z-[999]">
                <button onclick="toggleManual(event)" class="bg-blue-600 hover:bg-blue-700 text-white w-10 h-10 sm:w-12 sm:h-12 rounded-full shadow-lg flex items-center justify-center transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sm:h-7 sm:w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
                <div id="manual-box" class="hidden absolute top-14 right-0 w-64 sm:w-80 bg-white border border-slate-200 rounded-2xl shadow-2xl p-5 text-slate-700 text-left z-[1000]">
                    <h3 class="font-black text-blue-900 text-lg mb-3 flex items-center gap-2 border-b pb-2">ğŸ“– ä½¿ç”¨èªªæ˜æ›¸</h3>
                    <div class="space-y-3 text-sm leading-relaxed">
                        <p><strong>1. éš¨æ©Ÿç”Ÿæˆæ¨¡å¼ï¼š</strong> ç›´æ¥é»æ“ŠæŒ‰éˆ•ï¼Œæœƒå¾ã„…~ã„¦ 37å€‹æ³¨éŸ³ç¬¦è™Ÿä¸­ï¼Œéš¨æ©ŸæŒ‘é¸ä¸¦ä¸”ç”Ÿæˆ8å€‹é€ è©ã€‚</p>
                        <p><strong>2. æŒ‡å®šæ³¨éŸ³æ¨¡å¼ï¼š</strong> é»æ“Šé¸æ“‡æ³¨éŸ³ç¬¦è™Ÿï¼Œå¯ä»¥é‡å°ä½ æƒ³è¦ç·´ç¿’çš„æ³¨éŸ³ç¬¦è™Ÿï¼Œç”Ÿæˆ8å€‹é€ è©ã€‚</p>
                        <hr class="my-2 border-slate-100">
                        <p class="font-bold text-blue-600 underline">å¦‚ä½•å°å…¥ Gemini API Keyï¼š</p>
                        <ol class="list-decimal ml-4 space-y-1 text-[11px]">
                            <li>å‰å¾€ <a href="https://aistudio.google.com/" target="_blank" class="text-blue-500 font-bold underline">Google AI Studio</a> é»æ“Šã€ŒGet API Keyã€ç²å–é‡‘é‘°ã€‚</li>
                            <li>é»æ“Šæœ¬é åº•éƒ¨çš„ã€Œé€²éšè¨­å®šã€ã€‚</li>
                            <li>åœ¨å±•é–‹çš„è¼¸å…¥æ¡†è²¼å…¥é‡‘é‘°ï¼Œå³å¯é–‹å•Ÿ AI å³æ™‚ç”ŸæˆåŠŸèƒ½ã€‚</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸€ç»ƒä¹ åŒº -->
        <div id="section-top" class="mb-8 sm:mb-12 section-block">
            <div class="text-blue-600 font-black mb-4 flex items-center gap-2 px-1 text-xl sm:text-3xl">
                <span class="bg-blue-600 text-white px-2 py-0.5 rounded-lg text-sm sm:text-base font-bold">ç¬¬ä¸€å€</span> ä¸ŠåŠéƒ¨ç·´ç¿’
            </div>
            <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-xl shadow-blue-100/30 mb-6 border border-blue-50">
                <div class="flex flex-row gap-2 items-center justify-center">
                    <input type="text" class="zhuyin-input w-1/2 px-2 py-4 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-blue-400 focus:bg-white focus:outline-none text-xl text-center font-black" placeholder="é¸æ“‡æ³¨éŸ³" readonly onclick="openZhuyinPicker(event, this)">
                    <button onclick="handleSectionAction('section-top')" class="action-btn w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-black py-4 px-2 rounded-xl transition-all shadow-lg text-sm sm:text-xl flex items-center justify-center">
                        <span class="btn-text">éš¨æ©Ÿç”¢ç”Ÿé€ è©</span>
                    </button>
                </div>
            </div>
            <div class="result-area hidden"><div class="word-grid grid grid-cols-4 gap-1.5 sm:gap-4 md:gap-6"></div></div>
        </div>

        <hr class="section-divider border-dashed border-slate-300 mb-8 sm:mb-12">

        <!-- ç¬¬äºŒç»ƒä¹ åŒº -->
        <div id="section-bottom" class="mb-8 sm:mb-12 section-block">
            <div class="text-indigo-600 font-black mb-4 flex items-center gap-2 px-1 text-xl sm:text-3xl">
                <span class="bg-indigo-600 text-white px-2 py-0.5 rounded-lg text-sm sm:text-base font-bold">ç¬¬äºŒå€</span> ä¸‹åŠéƒ¨ç·´ç¿’
            </div>
            <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-xl shadow-indigo-100/30 mb-6 border border-indigo-50">
                <div class="flex flex-row gap-2 items-center justify-center">
                    <input type="text" class="zhuyin-input w-1/2 px-2 py-4 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-indigo-400 focus:bg-white focus:outline-none text-xl text-center font-black" placeholder="é¸æ“‡æ³¨éŸ³" readonly onclick="openZhuyinPicker(event, this)">
                    <button onclick="handleSectionAction('section-bottom')" class="action-btn w-1/2 bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 px-2 rounded-xl transition-all shadow-lg text-sm sm:text-xl flex items-center justify-center">
                        <span class="btn-text">éš¨æ©Ÿç”¢ç”Ÿé€ è©</span>
                    </button>
                </div>
            </div>
            <div class="result-area hidden"><div class="word-grid grid grid-cols-4 gap-1.5 sm:gap-4 md:gap-6"></div></div>
        </div>

        <!-- æŒ‰éˆ•æ“ä½œå€ -->
        <div class="mt-4 mb-4 flex flex-row gap-4 justify-center px-4 w-full">
            <button onclick="exportAsImage()" id="export-img-btn" class="flex-1 max-w-[280px] bg-emerald-600 text-white py-4 rounded-xl hover:bg-emerald-700 transition-all font-black shadow-lg flex items-center justify-center gap-2 text-sm sm:text-lg"><span>ğŸ–¼ï¸</span> è¼¸å‡ºåœ–ç‰‡</button>
            <button onclick="toggleSettings(event)" class="flex-1 max-w-[280px] bg-slate-800 text-white py-4 rounded-xl hover:bg-slate-700 transition-all font-black shadow-lg flex items-center justify-center gap-2 text-sm sm:text-lg"><span>âš™ï¸</span> é€²éšè¨­å®š</button>
        </div>

        <!-- é€²éšè¨­å®šå€ -->
        <div id="settings-area" class="hidden mb-12 p-5 bg-slate-100 border-2 border-slate-200 rounded-[2rem] transition-all">
            <div class="flex flex-col gap-4 px-2 text-left">
                <p class="text-slate-600 font-black text-lg text-center">Gemini API Key è¨­å®š</p>
                <input type="password" id="user-api-key" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-300 focus:border-blue-500 focus:outline-none text-lg font-bold shadow-inner" placeholder="åœ¨æ­¤è²¼å…¥ API é‡‘é‘°...">
            </div>
        </div>

        <div id="globalError" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-lg p-4 bg-red-600 text-white rounded-xl text-center shadow-2xl z-50 font-bold"></div>
    </div>

    <!-- è¼”åŠ© DOM -->
    <script>
        const apiKey = ""; // åˆå§‹åŒ–è®Šæ•¸é¿å… ReferenceError
        
        // åŸºæœ¬å‚™æ´è³‡æ–™åº«
        let SMART_LIB = {
            'ã„…': ['çˆ¸çˆ¸ ã„…ã„šË‹ ã„…ã„šË™', 'ç­†è¨˜ ã„…ã„§Ë‡ ã„ã„§Ë‹', 'é¤…ä¹¾ ã„…ã„§ã„¥Ë‡ ã„ã„¢', 'å¸ƒä¸ ã„…ã„¨Ë‹ ã„‰ã„§ã„¥', 'å ±ç´™ ã„…ã„ Ë‹ ã„“Ë‡', 'å†°ç®± ã„…ã„§ã„¥ ã„’ã„§ã„¤', 'ç»ç’ƒ ã„…ã„› ã„Œã„§ËŠ', 'åŒ…å« ã„…ã„  ã„ã„¢ËŠ'],
            'ã„†': ['æœ‹å‹ ã„†ã„¥ËŠ ã„§ã„¡Ë‡', 'è˜‹æœ ã„†ã„§ã„¥ËŠ ã„ã„¨ã„›Ë‡', 'çš®çƒ ã„†ã„§ËŠ ã„‘ã„§ã„¡ËŠ', 'æ‹æ‰‹ ã„†ã„ ã„•ã„¡Ë‡', 'ç€‘å¸ƒ ã„†ã„¨Ë‹ ã„…ã„¨Ë‹', 'çˆ¬å±± ã„†ã„šËŠ ã„•ã„¢', 'æ¼‚äº® ã„†ã„§ã„ Ë‹ ã„Œã„§ã„¤Ë‹', 'ç›¤å­ ã„†ã„¢ËŠ ã„—Ë™'],
            'ã„‡': ['åª½åª½ ã„‡ã„š ã„‡ã„šË™', 'å¸½å­ ã„‡ã„ Ë‹ ã„—Ë™', 'å¦¹å¦¹ ã„‡ã„ŸË‹ ã„‡ã„ŸË™', 'èèŸ» ã„‡ã„šË‡ ã„§Ë‡', 'é–€çª— ã„‡ã„£ËŠ ã„”ã„¨ã„¤', 'è²“å’ª ã„‡ã„  ã„‡ã„§', 'éºµåŒ… ã„‡ã„§ã„¢Ë‹ ã„…ã„ ', 'è²·èœ ã„‡ã„Ë‡ ã„˜ã„Ë‹'],
            'ã„ˆ': ['é¢¨è»Š ã„ˆã„¥ ã„”ã„œ', 'é£›æ©Ÿ ã„ˆã„Ÿ ã„ã„§', 'æˆ¿å­ ã„ˆã„¤ËŠ ã„—Ë™', 'çˆ¶æ¯ ã„ˆã„¨Ë‹ ã„‡ã„¨Ë‡', 'éå¸¸ ã„ˆã„Ÿ ã„”ã„¤ËŠ', 'æ–¹å¡Š ã„ˆã„¤ ã„ã„¨ã„Ë‹', 'è‚¥çš‚ ã„ˆã„ŸËŠ ã„—ã„ Ë‹', 'åˆ†æ•¸ ã„ˆã„£ ã„•ã„¨Ë‹'],
            'ã„‰': ['å¼Ÿå¼Ÿ ã„‰ã„§Ë‹ ã„‰ã„§Ë™', 'é›»è¦– ã„‰ã„§ã„¢Ë‹ ã„•Ë‹', 'æ‰“çƒ ã„‰ã„šË‡ ã„‘ã„§ã„¡ËŠ', 'åœ°çƒ ã„‰ã„§Ë‹ ã„‘ã„§ËŠ', 'å¤§æ¨¹ ã„‰ã„šË‹ ã„•ã„¨Ë‹', 'è›‹ç³• ã„‰ã„¢Ë‹ ã„ã„ ', 'ä½é ­ ã„‰ã„§ ã„Šã„¡ËŠ', 'å†¬å¤© ã„‰ã„¨ã„¥ ã„Šã„§ã„¢'],
            'ã„Š': ['å¤ªé™½ ã„Šã„Ë‹ ã„§ã„¤ËŠ', 'å¤©ç©º ã„Šã„§ã„¢ ã„ã„¨ã„¥', 'è·³èˆ ã„Šã„§ã„ Ë‹ ã„¨Ë‡', 'ç³–æœ ã„Šã„¤ËŠ ã„ã„¨ã„›Ë‡', 'é«”æ“ ã„Šã„§Ë‡ ã„˜ã„ ', 'å…”å­ ã„Šã„¨Ë‹ ã„—Ë™', 'ç‰¹åˆ¥ ã„Šã„œË‹ ã„…ã„§ã„ËŠ', 'éµè·¯ ã„Šã„§ã„Ë‡ ã„Œã„¨Ë‹'],
            'ã„‹': ['ç‰›å¥¶ ã„‹ã„§ã„¡ËŠ ã„‹ã„Ë‡', 'å¥¶å¥¶ ã„‹ã„Ë‡ ã„‹ã„Ë™', 'å—ç“œ ã„‹ã„¢ËŠ ã„ã„¨ã„š', 'æ³¥åœŸ ã„‹ã„§ËŠ ã„Šã„¨Ë‡', 'èƒ½åŠ› ã„‹ã„¥ËŠ ã„Œã„§Ë‹', 'å…§å®¹ ã„‹ã„ŸË‹ ã„–ã„¨ã„¥ËŠ', 'å“ªè£¡ ã„‹ã„šË‡ ã„Œã„§Ë‡', 'å¥³ç”Ÿ ã„‹ã„©Ë‡ ã„•ã„¥'],
            'ã„Œ': ['è€å¸« ã„Œã„ Ë‡ ã„•', 'ç±ƒçƒ ã„Œã„¢ËŠ ã„‘ã„§ã„¡ËŠ', 'æœˆäº® ã„©ã„Ë‹ ã„Œã„§ã„¤Ë‹', 'æ¢¨å­ ã„Œã„§ËŠ ã„—Ë™', 'ç¦®ç‰© ã„Œã„§Ë‡ ã„¨Ë‹', 'å–‡å­ ã„Œã„šË‡ ã„…ã„š', 'åŠ›é‡ ã„Œã„§Ë‹ ã„Œã„§ã„¤Ë‹', 'è·¯ç‡ˆ ã„Œã„¨Ë‹ ã„‰ã„¥'],
            'ã„': ['å“¥å“¥ ã„ã„œ ã„ã„œË™', 'å…¬åœ’ ã„ã„¨ã„¥ ã„©ã„¢ËŠ', 'æ•…äº‹ ã„ã„¨Ë‹ ã„•Ë‹', 'è¥¿ç“œ ã„’ã„§ ã„ã„¨ã„š', 'åœ‹æ—— ã„ã„¨ã„›ËŠ ã„‘ã„§ËŠ', 'ä¹–å·§ ã„ã„¨ã„ ã„‘ã„§ã„ Ë‡', 'å·¥ä½œ ã„ã„¨ã„¥ ã„—ã„¨ã„›Ë‹', 'å…¬å…± ã„ã„¨ã„¥ ã„ã„¨ã„¥Ë‹'],
            'ã„': ['é–‹æ°´ ã„ã„ ã„•ã„¨ã„ŸË‡', 'å£è¢‹ ã„ã„¡Ë‡ ã„‰ã„Ë‹', 'çœ‹æ›¸ ã„ã„¢Ë‹ ã„•ã„¨', 'çƒ¤è‚‰ ã„ã„ Ë‡ ã„–ã„¡Ë‹', 'ç§‘å­¸ ã„ã„œ ã„’ã„©ã„ËŠ', 'å›°é›£ ã„ã„¨ã„£Ë‹ ã„‹ã„¢ËŠ', 'å®¢å»³ ã„ã„œË‹ ã„Šã„§ã„¥', 'ç©ºæ°£ ã„ã„¨ã„¥ ã„‘ã„§Ë‹'],
            'ã„': ['å–æ°´ ã„ã„œ ã„•ã„¨ã„ŸË‡', 'æ²³æµ ã„ã„œËŠ ã„Œã„§ã„¡ËŠ', 'è´è¶ ã„ã„¨ËŠ ã„‰ã„§ã„ËŠ', 'å¥½äºº ã„ã„ Ë‡ ã„–ã„£ËŠ', 'èŠ±æœµ ã„ã„¨ã„š ã„‰ã„¨ã„›Ë‡', 'ç«è»Š ã„ã„¨ã„›Ë‡ ã„”ã„œ', 'æµ·æ´‹ ã„ã„Ë‡ ã„§ã„¤ËŠ', 'å›å®¶ ã„ã„¨ã„ŸËŠ ã„ã„§ã„š'],
            'ã„': ['è¨˜è€… ã„ã„§Ë‹ ã„“ã„œË‡', 'ç°¡å–® ã„ã„§ã„¢Ë‡ ã„‰ã„¢', 'å®¶äºº ã„ã„§ã„š ã„–ã„£ËŠ', 'é›è›‹ ã„ã„§ ã„‰ã„¢Ë‹', 'é€²æ­¥ ã„ã„§ã„£Ë‹ ã„…ã„¨Ë‹', 'å¥åº· ã„ã„§ã„¢Ë‹ ã„ã„¤', 'è­¦å¯Ÿ ã„ã„§ã„¥Ë‡ ã„”ã„šËŠ', 'é¡å­ ã„ã„§ã„¥Ë‹ ã„—Ë™'],
            'ã„‘': ['ç§‹å¤© ã„‘ã„§ã„¡ ã„Šã„§ã„¢', 'æ°£çƒ ã„‘ã„§Ë‹ ã„‘ã„§ã„¡ËŠ', 'å‰é¢ ã„‘ã„§ã„¢ËŠ ã„‡ã„§ã„¢Ë‹', 'èœ»èœ“ ã„‘ã„§ã„¥ ã„Šã„§ã„¥ËŠ', 'æ¸…æ½” ã„‘ã„§ã„¥ ã„ã„§ã„ËŠ', 'ä¼éµ ã„‘ã„§Ë‹ ã„œËŠ', 'æ±½è»Š ã„‘ã„§Ë‹ ã„”ã„œ', 'è«‹å• ã„‘ã„§ã„¥Ë‡ ã„¨ã„£Ë‹'],
            'ã„’': ['å­¸æ ¡ ã„’ã„©ã„ËŠ ã„’ã„§ã„ Ë‹', 'å°é› ã„’ã„§ã„ Ë‡ ã„ã„§', 'å–œæ­¡ ã„’ã„§Ë‡ ã„ã„¨ã„¢', 'æ´—æ‰‹ ã„’ã„§Ë‡ ã„•ã„¡Ë‡', 'è¾›è‹¦ ã„’ã„§ã„£ ã„ã„¨Ë‡', 'è¥¿ç“œ ã„’ã„§ ã„ã„¨ã„š', 'ä¼‘æ¯ ã„’ã„§ã„¡ ã„’ã„§ËŠ', 'å¸Œæœ› ã„’ã„§ ã„¨ã„¤Ë‹'],
            'ã„“': ['çŸ¥é“ ã„“ ã„‰ã„ Ë‹', 'ä¸­åˆ ã„“ã„¨ã„¥ ã„¨Ë‡', 'ç¨®æ¤ ã„“ã„¨ã„¥Ë‹ ã„“ËŠ', 'çœŸèª  ã„“ã„£ ã„”ã„¥ËŠ', 'æº–å‚™ ã„“ã„¨ã„£Ë‡ ã„…ã„ŸË‹', 'ç´™å¼µ ã„“Ë‡ ã„“ã„¤', 'æ•´ç† ã„“ã„¥Ë‡ ã„Œã„§Ë‡', 'é‡è¦ ã„“ã„¨ã„¥Ë‹ ã„§ã„ Ë‹'],
            'ã„”': ['åƒé£¯ ã„” ã„ˆã„¢Ë‹', 'æ˜¥å¤© ã„”ã„¨ã„£ ã„Šã„§ã„¢', 'å‡ºç™¼ ã„”ã„¨ ã„ˆã„š', 'æˆåŠŸ ã„”ã„¥ËŠ ã„ã„¨ã„¥', 'è»Šå­ ã„”ã„œ ã„—Ë™', 'å˜—è©¦ ã„”ã„¤ËŠ ã„•Ë‹', 'çª—æˆ¶ ã„”ã„¨ã„¤ ã„ã„¨Ë‹', 'é•·åº¦ ã„”ã„¤ËŠ ã„‰ã„¨Ë‹'],
            'ã„•': ['æ‰‹éŒ¶ ã„•ã„¡Ë‡ ã„…ã„§ã„ Ë‡', 'æ°´æœ ã„•ã„¨ã„ŸË‡ ã„ã„¨ã„›Ë‡', 'æ›¸æœ¬ ã„•ã„¨ ã„…ã„£Ë‡', 'å±±ä¸Š ã„•ã„¢ ã„•ã„¤Ë‹', 'èº«ä¸Š ã„•ã„£ ã„•ã„¤Ë‹', 'æ¨¹æœ¨ ã„•ã„¨Ë‹ ã„‡ã„¨Ë‹', 'ä¸–ç•Œ ã„•Ë‹ ã„ã„§ã„Ë‹', 'æ”¶ç©« ã„•ã„¡ ã„ã„¨ã„›Ë‹'],
            'ã„–': ['æ—¥æœ¬ ã„–Ë‹ ã„…ã„£Ë‡', 'æ—¥è¨˜ ã„–Ë‹ ã„ã„§Ë‹', 'æ—¥å¸¸ ã„–Ë‹ ã„”ã„¤ËŠ', 'å¦‚ä½• ã„–ã„¨ËŠ ã„ã„œËŠ', 'å¦‚æœ ã„–ã„¨ËŠ ã„ã„¨ã„›Ë‡', 'äººå“¡ ã„–ã„£ËŠ ã„©ã„¢ËŠ', 'èªçœŸ ã„–ã„£Ë‹ ã„“ã„£', 'ç†±é¬§ ã„–ã„œË‹ ã„‹ã„ Ë‹'],
            'ã„—': ['æ—©ä¸Š ã„—ã„ Ë‡ ã„•ã„¤Ë‹', 'åšå·¥ ã„—ã„¨ã„›Ë‹ ã„ã„¨ã„¥', 'è‡ªå¤§ ã„—Ë‹ ã„‰ã„šË‹', 'è‡ªç”± ã„—Ë‹ ã„§ã„¡ËŠ', 'èµ°è·¯ ã„—ã„¡Ë‡ ã„Œã„¨Ë‹', 'è¶³å¤  ã„—ã„¨ËŠ ã„ã„¡Ë‹', 'å­—å…¸ ã„—Ë‹ ã„‰ã„§ã„¢Ë‡', 'è‡ªå·± ã„—Ë‹ ã„ã„§Ë‡'],
            'ã„˜': ['è‰åœ° ã„˜ã„ Ë‡ ã„‰ã„§Ë‹', 'å½©è™¹ ã„˜ã„Ë‡ ã„ã„¨ã„¥ËŠ', 'æ¸¬é©— ã„˜ã„œË‹ ã„§ã„¢Ë‹', 'æ›¾ç¶“ ã„˜ã„¥ËŠ ã„ã„§ã„¥', 'æ“å ´ ã„˜ã„  ã„”ã„¤Ë‡', 'å±¤æ¬¡ ã„˜ã„¥ËŠ ã„˜Ë‹', 'ææ–™ ã„˜ã„ËŠ ã„Œã„§ã„ Ë‹', 'æ¬¡åº ã„˜Ë‹ ã„’ã„©Ë‹'],
            'ã„™': ['æ€è€ƒ ã„™ ã„ã„ Ë‡', 'å››æ–¹ ã„™Ë‹ ã„ˆã„¤', 'é€Ÿé£Ÿ ã„™ã„¨Ë‹ ã„•ËŠ', 'å¸æ©Ÿ ã„™ ã„ã„§', 'æ£®æ— ã„™ã„£ ã„Œã„§ã„£ËŠ', 'é€ç¦® ã„™ã„¨ã„¥Ë‹ ã„Œã„§Ë‡', 'å¡‘è†  ã„™ã„¨Ë‹ ã„ã„§ã„ ', 'å®¿èˆ ã„™ã„¨Ë‹ ã„•ã„œË‹'],
            'ã„š': ['é˜¿å§¨ ã„š ã„§ËŠ', 'å¤§å®¶ ã„‰ã„šË‹ ã„ã„§ã„š', 'å¢åŠ  ã„—ã„¥ ã„ã„§ã„š', 'é´¨å­ ã„§ã„š ã„—Ë™', 'æ‰“é›· ã„‰ã„šË‡ ã„Œã„ŸËŠ', 'æ‹‰é–‹ ã„Œã„š ã„ã„', 'æ€•é»‘ ã„†ã„šË‹ ã„ã„Ÿ', 'å“ˆå“ˆ ã„ã„š ã„ã„š'],
            'ã„›': ['è èœ ã„…ã„› ã„˜ã„Ë‹', 'æ’­å ± ã„…ã„› ã„…ã„ Ë‹', 'ç£¨åˆ ã„‡ã„›ËŠ ã„ã„œËŠ', 'æ½‘æ°´ ã„†ã„› ã„•ã„¨ã„ŸË‡', 'ç ´å£ ã„†ã„›Ë‹ ã„ã„¨ã„Ë‹', 'ä½›ç¶“ ã„ˆã„›ËŠ ã„ã„§ã„¥', 'è–„è†œ ã„…ã„›ËŠ ã„‡ã„›ËŠ', 'æœå‡ ã„ã„¨ã„›Ë‡ ã„‰ã„¨ã„¥Ë‹'],
            'ã„œ': ['ç‰¹è‰² ã„Šã„œË‹ ã„™ã„œË‹', 'æ²³é‚Š ã„ã„œËŠ ã„…ã„§ã„¢', 'ç†±é‡ ã„–ã„œË‹ ã„Œã„§ã„¤Ë‹', 'å€¼å¾— ã„“ËŠ ã„‰ã„œË™', 'æ¸¬é‡ ã„˜ã„œË‹ ã„Œã„§ã„¤ËŠ', 'åˆ»è‹¦ ã„ã„œË‹ ã„ã„¨Ë‡', 'éµè›‹ ã„œËŠ ã„‰ã„¢Ë‹', 'æƒ¡ç¿’ ã„œË‹ ã„’ã„§ËŠ'],
            'ã„': ['çˆºçˆº ã„§ã„ËŠ ã„§ã„Ë™', 'å¯«å­— ã„’ã„§ã„Ë‡ ã„—Ë‹', 'é‹å­ ã„’ã„§ã„ËŠ ã„—Ë™', 'è¬è¬ ã„’ã„§ã„Ë‹ ã„’ã„§ã„Ë™', 'å§å§ ã„ã„§ã„Ë‡ ã„ã„§ã„Ë‡', 'å’§å˜´ ã„Œã„§ã„Ë‡ ã„—ã„¨ã„ŸË‡', 'å¤œæ™š ã„§ã„Ë‹ ã„¨ã„¢Ë‡', 'è´è¶ ã„ã„¨ËŠ ã„‰ã„§ã„ËŠ'],
            'ã„': ['æ„›å¿ƒ ã„Ë‹ ã„’ã„§ã„£', 'çŸ®å° ã„Ë‡ ã„’ã„§ã„ Ë‡', 'æ‡‰è©² ã„§ã„¥ ã„ã„', 'å¾˜å¾Š ã„†ã„ËŠ ã„ã„¨ã„ËŠ', 'æ‹è³£ ã„†ã„ ã„‡ã„Ë‹', 'å¤–åœ‹ ã„¨ã„Ë‹ ã„ã„¨ã„›ËŠ', 'å®³èŸ² ã„ã„Ë‹ ã„”ã„¨ã„¥ËŠ', 'ä¾†åˆ° ã„Œã„ËŠ ã„‰ã„ Ë‹'],
            'ã„Ÿ': ['é£›æ©Ÿ ã„ˆã„Ÿ ã„ã„§', 'ç´¯ç© ã„Œã„ŸË‡ ã„ã„§', 'æ¯å­ ã„…ã„Ÿ ã„—Ë™', 'èƒŒå¾Œ ã„…ã„ŸË‹ ã„ã„¡Ë‹', 'æ­¸é¡ ã„ã„¨ã„Ÿ ã„Œã„ŸË‹', 'é…éŸ³ ã„†ã„ŸË‹ ã„§ã„£', 'æ²’æœ‰ ã„‡ã„ŸËŠ ã„§ã„¡Ë‡', 'å°é¢ ã„‰ã„¨ã„ŸË‹ ã„‡ã„§ã„¢Ë‹'],
            'ã„ ': ['é©•å‚² ã„ã„§ã„  ã„ Ë‹', 'å‡¹æ´ ã„  ã„‰ã„¨ã„¥Ë‹', 'å®£å‘Š ã„’ã„©ã„¢ ã„ã„ Ë‹', 'è€ƒè©¦ ã„ã„ Ë‡ ã„•Ë‹', 'æ‡Šæ‚” ã„ Ë‹ ã„ã„¨ã„ŸË‡', 'åŒ…å« ã„…ã„  ã„ã„¢ËŠ', 'è·‘æ­¥ ã„†ã„ Ë‡ ã„…ã„¨Ë‹', 'ä¾†åˆ° ã„Œã„ËŠ ã„‰ã„ Ë‹'],
            'ã„¡': ['æ­ç¾ ã„¡ ã„‡ã„ŸË‡', 'æµ·é·— ã„ã„Ë‡ ã„¡', 'å¶åƒ ã„¡Ë‡ ã„’ã„§ã„¤Ë‹', 'æ‰£å­ ã„ã„¡Ë‹ ã„—Ë™', 'å¾Œæ‚” ã„ã„¡Ë‹ ã„ã„¨ã„ŸË‡', 'éƒ½æœ‰ ã„‰ã„¡ ã„§ã„¡Ë‡', 'é€éœ² ã„Šã„¡Ë‹ ã„Œã„¨Ë‹', 'è‚‰ç‰‡ ã„–ã„¡Ë‹ ã„†ã„§ã„¢Ë‹'],
            'ã„¢': ['å®‰éœ ã„¢ ã„ã„§ã„¥Ë‹', 'æš—è™Ÿ ã„¢Ë‹ ã„ã„ Ë‹', 'å²¸é‚Š ã„¢Ë‹ ã„…ã„§ã„¢', 'ç­”æ¡ˆ ã„‰ã„šËŠ ã„¢Ë‹', 'å®‰æ’ ã„¢ ã„†ã„ËŠ', 'æ¬å®¶ ã„…ã„¢ ã„ã„§ã„š', 'ç›¤å­ ã„†ã„¢ËŠ ã„—Ë™', 'æ–¹é¢ ã„ˆã„¤ ã„‡ã„§ã„¢Ë‹'],
            'ã„£': ['æ©äºº ã„£ ã„–ã„£ËŠ', 'æ„Ÿæ© ã„ã„¢Ë‡ ã„£', 'æ ¹æœ¬ ã„ã„£ ã„…ã„£Ë‡', 'å™´æ³‰ ã„†ã„£ ã„‘ã„©ã„¢ËŠ', 'æœ¬èº« ã„…ã„£Ë‡ ã„•ã„£', 'ç›†æ ½ ã„†ã„£ËŠ ã„—ã„', 'é–€éˆ´ ã„‡ã„£ËŠ ã„Œã„§ã„¥ËŠ', 'ç­‰åˆ° ã„‰ã„¥Ë‡ ã„‰ã„ Ë‹'],
            'ã„¤': ['éª¯é«’ ã„¤ ã„—ã„¤', 'é«˜æ˜‚ ã„ã„  ã„¤ËŠ', 'æ‰‹æ§ ã„•ã„¡Ë‡ ã„‘ã„§ã„¤', 'é‹¼ç´ ã„ã„¤ ã„‘ã„§ã„£ËŠ', 'èƒ–å­ ã„†ã„¤Ë‹ ã„—Ë™', 'å¿™ç¢Œ ã„‡ã„¤ËŠ ã„Œã„¨Ë‹', 'æ–¹å‘ ã„ˆã„¤ ã„’ã„§ã„¤Ë‹', 'æ–‡ç«  ã„¨ã„£ËŠ ã„“ã„¤'],
            'ã„¥': ['é¢¨è»Š ã„ˆã„¥ ã„”ã„œ', 'ç‡ˆæ³¡ ã„‰ã„¥ ã„†ã„ Ë‹', 'å†·éœ ã„Œã„¥Ë‡ ã„ã„§ã„¥Ë‹', 'èƒ½é‡ ã„‹ã„¥ËŠ ã„Œã„§Ë‹', 'å¢åŠ  ã„—ã„¥ ã„ã„§ã„š', 'æ£šæ¶ ã„†ã„¥ËŠ ã„ã„§ã„šË‹', 'è’™å¤ ã„‡ã„¥ËŠ ã„ã„¨Ë‡', 'æ›¾ç¶“ ã„˜ã„¥ËŠ ã„ã„§ã„¥'],
            'ã„¦': ['å…’å­ ã„¦ËŠ ã„—Ë™', 'å…’ç«¥ ã„¦ËŠ ã„Šã„¨ã„¥ËŠ', 'è€³ç’° ã„¦Ë‡ ã„ã„¨ã„¢ËŠ', 'äºŒèƒ¡ ã„¦Ë‹ ã„ã„¨ËŠ', 'è€Œå» ã„¦ËŠ ã„‘ã„©Ë‹', 'å¹¼å…’ ã„§ã„¡Ë‹ ã„¦ËŠ', 'å­¤å…’ ã„ã„¨ ã„¦ËŠ', 'å…’æ­Œ ã„¦ËŠ ã„ã„œ'],
            'ã„§': ['é†«ç”Ÿ ã„§ ã„•ã„¥', 'è¡£æ«ƒ ã„§ ã„ã„¨ã„ŸË‹', 'ä¸€èµ· ã„§ ã„‘ã„§Ë‡', 'æ„è¦‹ ã„§Ë‹ ã„ã„§ã„¢Ë‹', 'æ„å¤– ã„§Ë‹ ã„¨ã„Ë‹', 'ç­†ç•« ã„…ã„§Ë‡ ã„ã„¨ã„šË‹', 'å¥‡æ€ª ã„‘ã„§ËŠ ã„ã„¨ã„Ë‹', 'å¸Œæœ› ã„’ã„§ ã„¨ã„¤Ë‹'],
            'ã„¨': ['å±‹é ‚ ã„¨ ã„‰ã„§ã„¥Ë‡', 'æ±¡æ³¥ ã„¨ ã„‹ã„§ËŠ', 'ç„¡ç·š ã„¨ËŠ ã„’ã„§ã„¢Ë‹', 'æ±¡æŸ“ ã„¨ ã„–ã„¢Ë‡', 'æ­¦å™¨ ã„¨Ë‡ ã„‘ã„§Ë‹', 'ä¸ä½† ã„…ã„¨ËŠ ã„‰ã„¢Ë‹', 'ç€‘å¸ƒ ã„†ã„¨Ë‹ ã„…ã„¨Ë‹', 'èˆ’æœ ã„•ã„¨ ã„ˆã„¨ËŠ'],
            'ã„©': ['æœˆäº® ã„©ã„Ë‹ ã„Œã„§ã„¤Ë‹', 'ç‰ç±³ ã„©Ë‹ ã„‡ã„§Ë‡', 'é›¨è¡£ ã„©Ë‡ ã„§', 'èªè¨€ ã„©Ë‡ ã„§ã„¢ËŠ', 'æµ´å®¤ ã„©Ë‹ ã„•Ë‹', 'é­šç¼¸ ã„©ËŠ ã„ã„¤', 'å®‡å®™ ã„©Ë‡ ã„“ã„¡', 'æ„‰å¿« ã„©ËŠ ã„ã„¨ã„Ë‹']
        };

        // è³‡æ–™åº«é€£å‹•ï¼šæª¢æŸ¥ EXTENDED_WORDS æ˜¯å¦å¾å¤–éƒ¨ .js è¼‰å…¥
        window.addEventListener('load', () => {
            if (typeof EXTENDED_WORDS !== 'undefined') {
                for (let zy in EXTENDED_WORDS) {
                    if (SMART_LIB[zy]) {
                        SMART_LIB[zy] = [...new Set([...SMART_LIB[zy], ...EXTENDED_WORDS[zy]])];
                    } else {
                        SMART_LIB[zy] = EXTENDED_WORDS[zy];
                    }
                }
            }
        });

        let sectionState = {
            'section-top': { words: [], status: 'éš¨æ©Ÿ', val: '' },
            'section-bottom': { words: [], status: 'éš¨æ©Ÿ', val: '' }
        };

        function toggleManual(e) {
            e.stopPropagation();
            const box = document.getElementById('manual-box');
            if (box) box.classList.toggle('hidden');
        }

        function openZhuyinPicker(e, inputEl) {
            e.stopPropagation();
            let picker = document.getElementById('zhuyin-picker');
            if (!picker) {
                picker = document.createElement('div');
                picker.id = 'zhuyin-picker';
                document.body.appendChild(picker);
            }
            const rect = inputEl.getBoundingClientRect();
            picker.innerHTML = '';
            allZhuyin.split('').forEach(char => {
                const key = document.createElement('div');
                key.className = 'picker-key';
                key.innerText = char;
                key.onclick = (event) => {
                    event.stopPropagation();
                    inputEl.value = char;
                    const section = inputEl.closest('.section-block');
                    if (section) section.querySelector('.btn-text').innerText = "ç”¢ç”Ÿé€ è©";
                    closeAllPickers();
                };
                picker.appendChild(key);
            });
            picker.style.display = 'grid';
            let top = rect.bottom + window.scrollY + 10;
            let left = rect.left + window.scrollX;
            const pickerWidth = window.innerWidth > 640 ? 380 : 300; 
            if (left + pickerWidth > window.innerWidth) left = window.innerWidth - pickerWidth - 20;
            if (left < 10) left = 10;
            picker.style.top = `${top}px`;
            picker.style.left = `${left}px`;
        }

        function closeAllPickers() {
            const picker = document.getElementById('zhuyin-picker');
            if (picker) picker.style.display = 'none';
            const manual = document.getElementById('manual-box');
            if (manual) manual.classList.add('hidden');
        }

        function toggleSettings(e) {
            e.stopPropagation();
            const area = document.getElementById('settings-area');
            if (area) {
                area.classList.toggle('hidden');
                if (!area.classList.contains('hidden')) {
                    area.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function setupValidation() {
            document.querySelectorAll('.zhuyin-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const section = e.target.closest('.section-block');
                    const btnText = section.querySelector('.btn-text');
                    let val = e.target.value.trim();
                    if (val.length > 0) {
                        const lastChar = val.charAt(val.length - 1);
                        if (allZhuyin.includes(lastChar)) {
                            e.target.value = lastChar;
                            btnText.innerText = "ç”¢ç”Ÿé€ è©";
                        } else { e.target.value = ""; btnText.innerText = "éš¨æ©Ÿç”¢ç”Ÿé€ è©"; }
                    } else { btnText.innerText = "éš¨æ©Ÿç”¢ç”Ÿé€ è©"; }
                });
            });
        }

        function renderToSection(sectionId, words) {
            const section = document.getElementById(sectionId);
            const grid = section.querySelector('.word-grid');
            if (!grid) return;
            grid.innerHTML = '';
            words.forEach(item => {
                const text = typeof item === 'string' ? item.split(' ')[0] : item.text;
                const zyRaw = typeof item === 'string' ? item.split(' ').slice(1) : item.zhuyin.split(' ');
                const card = document.createElement('div');
                card.className = "bg-white border-2 border-slate-100 rounded-xl shadow-sm p-1.5 flex items-center justify-center";
                let wordHTML = `<div class="word-container">`;
                text.split('').forEach((char, i) => {
                    const zyStr = zyRaw[i] || "";
                    let symbols = '', tone = '', toneClass = '';
                    for (let c of zyStr) {
                        if (['ËŠ', 'Ë‡', 'Ë‹'].includes(c)) { tone = c; toneClass = 'tone-side'; }
                        else if (c === 'Ë™') { tone = c; toneClass = 'tone-top'; }
                        else if (c !== ' ') { symbols += `<span class="block">${c}</span>`; }
                    }
                    wordHTML += `<div class="char-unit"><div class="zhuyin-wrapper"><div class="zhuyin-symbols">${symbols}${tone ? `<div class="${toneClass}">${tone}</div>` : ''}</div></div><div class="char-text">${char}</div></div>`;
                });
                wordHTML += `</div>`; card.innerHTML = wordHTML; grid.appendChild(card);
            });
            section.querySelector('.result-area').classList.remove('hidden');
        }

        async function handleSectionAction(sectionId) {
            const section = document.getElementById(sectionId);
            const inputField = section.querySelector('.zhuyin-input');
            const input = inputField ? inputField.value.trim() : "";
            const btnText = section.querySelector('.btn-text');
            const userKeyField = document.getElementById('user-api-key');
            const userKey = userKeyField ? userKeyField.value.trim() : "";
            const currentKey = apiKey || userKey;
            const otherId = sectionId === 'section-top' ? 'section-bottom' : 'section-top';
            const existing = sectionState[otherId].words.map(w => typeof w === 'string' ? w.split(' ')[0] : w.text);

            const oldBtnText = btnText.innerText; btnText.innerHTML = `<div class="loader"></div>`;

            if (currentKey) {
                try {
                    let prompt = input ? `é‡å°æ³¨éŸ³ã€${input}ã€ç”Ÿæˆ 8 å€‹å¸¸ç”¨çš„é€ è©ã€‚` : `éš¨æ©Ÿé¸ä¸€å€‹æ³¨éŸ³ç¬¦è™Ÿç”Ÿæˆ 8 å€‹å¸¸ç”¨çš„é€ è©ã€‚`;
                    prompt += ` æ¢ä»¶ï¼šè©å½™é•·åº¦å¿…é ˆå‰›å¥½ç‚º 2 å€‹å­—ï¼Œä¸å¯åŒ…å« [${existing.join(', ')}]ã€‚JSONæ ¼å¼ï¼š{"words": [{"text": "...", "zhuyin": "..."}]}`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } } ) });
                    const result = await res.json();
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    const finalWords = data.words.filter(w => w.text.length === 2).slice(0, 8);
                    sectionState[sectionId] = { words: finalWords, status: input ? 'æŒ‡å®š' : 'éš¨æ©Ÿ', val: input };
                    renderToSection(sectionId, finalWords); btnText.innerText = oldBtnText; return;
                } catch (e) { }
            }

            let resultWords = [];
            if (input) {
                const pool = SMART_LIB[input] || ['ç„¡è³‡æ–™ ã„¨ËŠ ã„— ã„Œã„§ã„ Ë‹'];
                resultWords = pool.filter(w => w.split(' ')[0].length === 2).sort(() => 0.5 - Math.random()).filter(w => !existing.includes(w.split(' ')[0])).slice(0, 8);
            } else {
                const keys = Object.keys(SMART_LIB);
                const randomZy = keys[Math.floor(Math.random() * keys.length)];
                const pool = SMART_LIB[randomZy];
                resultWords = pool.filter(w => w.split(' ')[0].length === 2).sort(() => 0.5 - Math.random()).filter(w => !existing.includes(w.split(' ')[0])).slice(0, 8);
            }
            sectionState[sectionId] = { words: resultWords, status: input ? 'æŒ‡å®š' : 'éš¨æ©Ÿ', val: input };
            renderToSection(sectionId, resultWords); btnText.innerText = oldBtnText;
        }

        function renderPerfectImage() {
            const captureContent = document.getElementById('capture-content');
            captureContent.innerHTML = `<div style="text-align:center; font-size:46px; font-weight:900; margin-top:10px; margin-bottom:40px; color:#1e293b;">æ³¨éŸ³é€ è©ç·´ç¿’å–®</div>`;
            const addSection = (sectionId, baseTitle) => {
                const data = sectionState[sectionId]; if (data.words.length === 0) return;
                let marginTop = (sectionId === 'section-bottom') ? "40px" : "5px";
                const titleEl = document.createElement('div');
                titleEl.style.cssText = `font-size:28px; font-weight:900; border-bottom:4px solid #2563eb; padding-bottom:12px; margin:${marginTop} 0 35px 0; color:#334155; width:100%;`;
                titleEl.innerText = data.status === 'éš¨æ©Ÿ' ? `${baseTitle} éš¨æ©Ÿç”Ÿæˆé€ è©` : `${baseTitle} [${data.val}] çš„é€ è©ç·´ç¿’`;
                captureContent.appendChild(titleEl);
                const grid = document.createElement('div'); 
                grid.style.cssText = "display:grid; grid-template-columns:repeat(4, 1fr); grid-template-rows:repeat(2, 1fr); gap:25px 20px; width:100%;";
                data.words.forEach(item => {
                    const wordBox = document.createElement('div'); 
                    wordBox.style.cssText = `display:flex; flex-direction:column; align-items:center; justify-content:center; height:220px; background:#ffffff; border:3px solid #94a3b8; border-radius:40px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); overflow:visible;`;
                    const text = typeof item === 'string' ? item.split(' ')[0] : item.text;
                    const zyRaw = typeof item === 'string' ? item.split(' ').slice(1) : item.zhuyin.split(' ');
                    text.split('').forEach((char, i) => {
                        const row = document.createElement('div'); row.style.cssText = `display:flex; flex-direction:row; align-items:center; justify-content:center; height:100px; width:100%; position:relative;`;
                        const charEl = document.createElement('div'); charEl.innerText = char; 
                        charEl.style.cssText = `font-family:'Noto Serif TC', serif; font-size:4.8rem; font-weight:900; color:#000; margin-right:15px; display:flex; align-items:center; justify-content:center; height:100px; margin-top:-72px;`;
                        const zyBox = document.createElement('div'); 
                        zyBox.style.cssText = `position:relative; width:45px; height:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; margin-top:-27px;`;
                        const zySymbols = document.createElement('div'); zySymbols.style.cssText = `display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:1.6rem; font-weight:bold; color:#2563eb; line-height:1.05;`;
                        const zyStr = zyRaw[i] || ""; let symbols = "", tone = "", toneClass = "";
                        for(let c of zyStr) { 
                            if(['ËŠ','Ë‡','Ë‹'].includes(c)) { tone = c; toneClass = "side"; } 
                            else if(c === 'Ë™') { tone = c; toneClass = "top"; } 
                            else { symbols += `<span style="display:block;">${c}</span>`; } 
                        }
                        zySymbols.innerHTML = symbols; zyBox.appendChild(zySymbols);
                        if(tone) {
                            const toneEl = document.createElement('div'); toneEl.innerText = tone; toneEl.style.cssText = `position:absolute; color:#ef4444; font-weight:900;`;
                            if(toneClass === 'side') { toneEl.style.right = "-12px"; toneEl.style.top = "50%"; toneEl.style.transform = "translateY(-50%)"; toneEl.style.fontSize = "1.5rem"; }
                            else { toneEl.style.top = "2px"; toneEl.style.left = "50%"; toneEl.style.transform = "translateX(-50%)"; toneEl.style.fontSize = "1.6rem"; }
                            zyBox.appendChild(toneEl);
                        }
                        row.appendChild(charEl); row.appendChild(zyBox); wordBox.appendChild(row);
                    });
                    grid.appendChild(wordBox);
                });
                captureContent.appendChild(grid);
            };
            addSection('section-top', "ç¬¬ä¸€å€ ä¸ŠåŠéƒ¨ç·´ç¿’"); addSection('section-bottom', "ç¬¬äºŒå€ ä¸‹åŠéƒ¨ç·´ç¿’");
        }

        window.onload = function() { setupValidation(); };

        async function exportAsImage() {
            const btn = document.getElementById('export-img-btn');
            if (sectionState['section-top'].words.length === 0 && sectionState['section-bottom'].words.length === 0) {
                alert("è«‹å…ˆç”¢ç”Ÿé€ è©å–”ï¼"); return;
            }
            btn.disabled = true; btn.innerHTML = `<div class="loader"></div>`;
            renderPerfectImage(); 
            try {
                const area = document.getElementById('capture-area');
                const canvas = await html2canvas(area, { scale: 2, useCORS: true, backgroundColor: "#ffffff", width: 1000, height: 1414, onclone: (doc) => { doc.getElementById('capture-area').style.left = "0"; } });
                const link = document.createElement('a'); link.download = `æ³¨éŸ³é€ è©å–®_${new Date().getTime()}.png`; link.href = canvas.toDataURL("image/png"); link.click();
            } catch (err) { alert("è¼¸å‡ºå¤±æ•—"); }
            finally { btn.disabled = false; btn.innerHTML = `<span>ğŸ–¼ï¸</span> è¼¸å‡ºåœ–ç‰‡`; }
        }
    </script>
</body>
</html>